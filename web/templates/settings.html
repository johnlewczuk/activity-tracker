<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Activity Tracker</title>
    <style>
        :root {
            color-scheme: light dark;
            --bg: #0d1117;
            --surface: #161b22;
            --surface-2: #21262d;
            --border: #30363d;
            --text: #c9d1d9;
            --muted: #8b949e;
            --accent: #58a6ff;
            --accent-strong: #1f6feb;
            --accent-soft: #79c0ff;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
            --text-inverse: #ffffff;
            --accent-rgb: 88, 166, 255;
            --shadow-accent: rgba(88, 166, 255, 0.2);
        }

        @media (prefers-color-scheme: light) {
            :root {
                color-scheme: light;
                --bg: #f6f8fa;
                --surface: #ffffff;
                --surface-2: #eef1f5;
                --border: #d0d7de;
                --text: #1f2328;
                --muted: #57606a;
                --accent: #0969da;
                --accent-strong: #0550ae;
                --accent-soft: #218bff;
                --success: #1a7f37;
                --warning: #9a6700;
                --danger: #cf222e;
                --text-inverse: #ffffff;
                --accent-rgb: 9, 105, 218;
                --shadow-accent: rgba(9, 105, 218, 0.18);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 10px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .nav-links a {
            color: var(--muted);
            text-decoration: none;
            font-size: 0.9rem;
            padding: 8px 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            border-bottom: 2px solid transparent;
        }

        .nav-links a:hover {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .nav-links a.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            font-weight: 600;
        }

        .nav-icon {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }

        @media (max-width: 600px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        .settings-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
        }

        .settings-section h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .section-icon {
            width: 20px;
            height: 20px;
            stroke: var(--accent);
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-row.column {
            flex-direction: column;
            align-items: stretch;
        }

        .settings-label {
            flex: 1;
            min-width: 0;
        }

        .settings-label h3 {
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 2px;
            color: var(--text);
        }

        .settings-label p {
            font-size: 0.8rem;
            color: var(--muted);
        }

        .settings-control {
            flex: 0 0 220px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 600px) {
            .settings-row {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .settings-control {
                flex: 1;
            }
        }

        input[type="range"] {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            transition: transform 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
        }

        .slider-value {
            min-width: 50px;
            text-align: right;
            font-variant-numeric: tabular-nums;
            font-size: 0.9rem;
            color: var(--text);
            font-weight: 500;
        }

        select, input[type="text"] {
            background: var(--surface-2);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.85rem;
            width: 100%;
            transition: border-color 0.2s;
        }

        select:hover, input[type="text"]:hover {
            border-color: var(--accent);
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--shadow-accent);
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
            flex-shrink: 0;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .3s;
            border-radius: 22px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        .toggle input:checked + .toggle-slider {
            background-color: var(--accent);
        }

        .toggle input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        button {
            background: var(--accent);
            color: var(--text-inverse);
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: var(--accent-strong);
        }

        button.secondary {
            background: var(--surface-2);
            color: var(--text);
            border: 1px solid var(--border);
        }

        button.secondary:hover {
            background: var(--border);
            border-color: var(--accent);
        }

        button.danger {
            background: var(--danger);
        }

        button.danger:hover {
            background: #b91c1c;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-badge.running {
            background: rgba(63, 185, 80, 0.15);
            color: var(--success);
        }

        .status-badge.stopped {
            background: rgba(248, 81, 73, 0.15);
            color: var(--danger);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-soft));
            transition: width 0.3s;
            border-radius: 3px;
        }

        .monitor-list {
            list-style: none;
            margin-top: 12px;
        }

        .monitor-item {
            padding: 10px 12px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .monitor-item:last-child {
            margin-bottom: 0;
        }

        .monitor-item.primary {
            border-left: 3px solid var(--accent);
        }

        .monitor-icon {
            width: 16px;
            height: 16px;
            stroke: var(--muted);
            fill: none;
            stroke-width: 2;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            animation: slideIn 0.3s;
            font-size: 0.9rem;
            z-index: 1000;
        }

        .toast.show {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.success {
            border-left: 3px solid var(--success);
        }

        .toast.error {
            border-left: 3px solid var(--danger);
        }

        .toast.warning {
            border-left: 3px solid var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            min-height: 80px;
            margin-top: 12px;
            transition: border-color 0.2s;
        }

        .tag-input-container:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--shadow-accent);
        }

        .tag {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 4px 10px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
        }

        .tag-remove {
            cursor: pointer;
            color: var(--muted);
            font-weight: bold;
            line-height: 1;
            transition: color 0.2s;
        }

        .tag-remove:hover {
            color: var(--danger);
        }

        .tag-input {
            flex: 1;
            min-width: 150px;
            border: none;
            background: none;
            color: var(--text);
            outline: none;
            font-size: 0.85rem;
            padding: 4px;
        }

        .tag-input::placeholder {
            color: var(--muted);
        }

        .actions-row {
            display: flex;
            gap: 12px;
            padding-top: 12px;
            flex-wrap: wrap;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent);
        }

        .storage-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .storage-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
        }

        .storage-used {
            color: var(--text);
            font-weight: 500;
        }

        .storage-max {
            color: var(--muted);
        }

        .restart-notice {
            font-size: 0.75rem;
            color: var(--warning);
            margin-top: 4px;
        }

        /* Sticky Save Bar */
        .save-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 12px 20px;
            z-index: 1000;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .save-bar.hidden {
            transform: translateY(100%);
        }

        .save-bar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .unsaved-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--warning);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .save-buttons {
            display: flex;
            gap: 10px;
        }

        .restart-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--warning);
            color: #000;
        }

        .restart-btn:hover {
            background: #b88a00;
        }

        /* Add bottom padding to container when save bar is visible */
        body.has-unsaved .container {
            padding-bottom: 80px;
        }

        /* Input changed indicator */
        .input-changed {
            border-color: var(--warning) !important;
            box-shadow: 0 0 0 2px rgba(210, 153, 34, 0.2) !important;
        }

        .toggle input:not(:checked) + .toggle-slider.changed,
        .toggle input:checked + .toggle-slider.changed {
            box-shadow: 0 0 0 2px rgba(210, 153, 34, 0.4);
        }

        /* Unsaved Changes Banner */
        .unsaved-banner {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(210, 153, 34, 0.15);
            border: 1px solid var(--warning);
            border-radius: 6px;
            color: var(--warning);
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .unsaved-banner.hidden {
            display: none;
        }

        /* Actions Divider */
        .actions-divider {
            border: none;
            border-top: 1px solid var(--border);
            margin: 16px 0;
        }

        /* Button with icon */
        button svg {
            flex-shrink: 0;
        }

        #saveActions button,
        .actions-row button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* Disabled state for save buttons when no changes */
        #saveBtn:disabled,
        #discardBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #saveRestartBtn {
            display: none;
        }

        #saveRestartBtn.visible {
            display: inline-flex;
        }

        /* Refresh button for models dropdown */
        .refresh-btn {
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .refresh-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--text-inverse);
        }

        .refresh-btn.loading svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Activity Tracker</h1>
            <div class="nav-links">
                <a href="/timeline" id="timelineNav">
                    <svg class="nav-icon" viewBox="0 0 24 24">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    Timeline
                </a>
                <a href="/analytics" id="analyticsNav">
                    <svg class="nav-icon" viewBox="0 0 24 24">
                        <line x1="12" y1="20" x2="12" y2="10"></line>
                        <line x1="18" y1="20" x2="18" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="16"></line>
                    </svg>
                    Analytics
                </a>
                <a href="/settings" id="settingsNav" class="active">
                    <svg class="nav-icon" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    Settings
                </a>
            </div>
        </header>

        <div class="settings-grid">
            <!-- Capture Settings -->
            <div class="settings-section">
                <h2>
                    <svg class="section-icon" viewBox="0 0 24 24">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    Capture
                </h2>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Interval</h3>
                        <p>Time between screenshots</p>
                        <span class="restart-notice">Requires restart</span>
                    </div>
                    <div class="settings-control">
                        <input type="range" id="interval_seconds" min="10" max="120" step="10">
                        <span class="slider-value"><span id="interval_seconds_value">30</span>s</span>
                    </div>
                </div>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Format</h3>
                        <p>Screenshot file format</p>
                    </div>
                    <div class="settings-control">
                        <select id="format">
                            <option value="webp">WebP (recommended)</option>
                            <option value="png">PNG</option>
                            <option value="jpg">JPEG</option>
                        </select>
                    </div>
                </div>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Quality</h3>
                        <p>Compression quality</p>
                    </div>
                    <div class="settings-control">
                        <input type="range" id="quality" min="50" max="100" step="5">
                        <span class="slider-value"><span id="quality_value">80</span>%</span>
                    </div>
                </div>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Active Monitor Only</h3>
                        <p>Only capture focused monitor</p>
                    </div>
                    <div class="settings-control">
                        <label class="toggle">
                            <input type="checkbox" id="capture_active_monitor_only">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- AFK Detection -->
            <div class="settings-section">
                <h2>
                    <svg class="section-icon" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    AFK Detection
                </h2>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Timeout</h3>
                        <p>Inactivity before marking AFK</p>
                        <span class="restart-notice">Requires restart</span>
                    </div>
                    <div class="settings-control">
                        <input type="range" id="timeout_seconds" min="60" max="600" step="30">
                        <span class="slider-value"><span id="timeout_seconds_value">180</span>s</span>
                    </div>
                </div>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Min Session Length</h3>
                        <p>Minimum session duration to keep</p>
                    </div>
                    <div class="settings-control">
                        <input type="range" id="min_session_minutes" min="1" max="30" step="1">
                        <span class="slider-value"><span id="min_session_minutes_value">5</span>m</span>
                    </div>
                </div>
            </div>

            <!-- Summarization -->
            <div class="settings-section">
                <h2>
                    <svg class="section-icon" viewBox="0 0 24 24">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                    AI Summarization
                </h2>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Enable Summarization</h3>
                        <p>Generate activity summaries</p>
                    </div>
                    <div class="settings-control">
                        <label class="toggle">
                            <input type="checkbox" id="summarization_enabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Model</h3>
                        <p>Ollama model for summarization</p>
                    </div>
                    <div class="settings-control">
                        <select id="model">
                            <option value="">Loading models...</option>
                        </select>
                        <button type="button" class="refresh-btn" onclick="loadOllamaModels()" title="Refresh models list">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Trigger Threshold</h3>
                        <p>Screenshots before auto-summarizing</p>
                    </div>
                    <div class="settings-control">
                        <input type="range" id="trigger_threshold" min="5" max="30" step="1">
                        <span class="slider-value"><span id="trigger_threshold_value">10</span></span>
                    </div>
                </div>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Enable OCR</h3>
                        <p>Extract text from screenshots</p>
                    </div>
                    <div class="settings-control">
                        <label class="toggle">
                            <input type="checkbox" id="ocr_enabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Crop to Window</h3>
                        <p>Use cropped screenshots for OCR</p>
                    </div>
                    <div class="settings-control">
                        <label class="toggle">
                            <input type="checkbox" id="crop_to_window">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Include Previous Summary</h3>
                        <p>Add context from last summary</p>
                    </div>
                    <div class="settings-control">
                        <label class="toggle">
                            <input type="checkbox" id="include_previous_summary">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Storage -->
            <div class="settings-section">
                <h2>
                    <svg class="section-icon" viewBox="0 0 24 24">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>
                    Storage
                </h2>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Data Directory</h3>
                        <p>Location for screenshots</p>
                    </div>
                    <div class="settings-control">
                        <input type="text" id="data_dir" readonly style="opacity: 0.7; cursor: not-allowed;">
                    </div>
                </div>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Retention Period</h3>
                        <p>Delete older data (0 = unlimited)</p>
                    </div>
                    <div class="settings-control">
                        <input type="range" id="max_days_retention" min="0" max="365" step="30">
                        <span class="slider-value"><span id="max_days_retention_value">90</span>d</span>
                    </div>
                </div>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Max Storage</h3>
                        <p>Storage limit (0 = unlimited)</p>
                    </div>
                    <div class="settings-control">
                        <input type="range" id="max_gb_storage" min="0" max="200" step="10">
                        <span class="slider-value"><span id="max_gb_storage_value">50</span>GB</span>
                    </div>
                </div>

                <div class="settings-row column">
                    <div class="settings-label">
                        <h3>Current Usage</h3>
                    </div>
                    <div class="storage-info">
                        <div class="storage-text">
                            <span class="storage-used"><span id="storage_used">0</span> GB used</span>
                            <span class="storage-max"><span id="storage_max">50</span> GB limit</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="storage_progress" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Privacy -->
            <div class="settings-section">
                <h2>
                    <svg class="section-icon" viewBox="0 0 24 24">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    Privacy
                </h2>

                <div class="settings-row column">
                    <div class="settings-label">
                        <h3>Excluded Apps</h3>
                        <p>Apps to exclude from tracking (press Enter to add)</p>
                    </div>
                    <div id="excluded_apps_container" class="tag-input-container">
                        <input type="text" class="tag-input" id="excluded_apps_input" placeholder="Type app name and press Enter...">
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="settings-section">
                <h2>
                    <svg class="section-icon" viewBox="0 0 24 24">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                    System Status
                </h2>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Ollama</h3>
                        <p>AI summarization service</p>
                    </div>
                    <div class="settings-control">
                        <span class="status-badge" id="ollama_status">Checking...</span>
                    </div>
                </div>

                <div class="settings-row">
                    <div class="settings-label">
                        <h3>Screenshots</h3>
                        <p>Total captured</p>
                    </div>
                    <div class="settings-control">
                        <span class="stat-value" id="screenshot_count">-</span>
                    </div>
                </div>

                <div class="settings-row column">
                    <div class="settings-label">
                        <h3>Monitors</h3>
                        <p>Detected displays</p>
                    </div>
                    <ul class="monitor-list" id="monitor_list"></ul>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="settings-section" style="margin-top: 20px;" id="actionsSection">
            <h2>
                <svg class="section-icon" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                Actions
            </h2>

            <!-- Unsaved Changes Indicator -->
            <div id="unsavedIndicator" class="unsaved-banner hidden">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <span>You have unsaved changes</span>
            </div>

            <!-- Save Actions -->
            <div class="actions-row" id="saveActions">
                <button onclick="saveChanges()" id="saveBtn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save
                </button>
                <button class="restart-btn" onclick="saveAndRestart()" id="saveRestartBtn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    Save &amp; Restart
                </button>
                <button class="secondary" onclick="discardChanges()" id="discardBtn">Discard Changes</button>
            </div>

            <hr class="actions-divider">

            <!-- Other Actions -->
            <div class="actions-row">
                <button class="secondary" onclick="exportConfig()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Export Configuration
                </button>
                <button class="danger" onclick="resetConfig()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18"></path>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                    </svg>
                    Reset to Defaults
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Save Reminder (shows when scrolled away from Actions) -->
    <div id="saveBar" class="save-bar hidden">
        <div class="save-bar-content">
            <span class="unsaved-indicator">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                Unsaved changes
            </span>
            <div class="save-buttons">
                <button onclick="saveChanges()">Save</button>
                <button class="restart-btn" onclick="saveAndRestart()" id="floatingSaveRestartBtn" style="display: none;">Save &amp; Restart</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        let config = {};           // Current saved config
        let originalConfig = {};   // Copy of original for comparison
        let pendingChanges = {};   // Track unsaved changes: { elementId: { section, key, value } }
        let requiresRestart = false;

        // Settings that require restart
        const restartRequiredKeys = new Set([
            'interval_seconds',
            'timeout_seconds',
            'host',
            'port',
            'data_dir'
        ]);

        // Load configuration on page load
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                config = await response.json();
                originalConfig = JSON.parse(JSON.stringify(config)); // Deep copy
                pendingChanges = {};
                requiresRestart = false;
                updateUI(config);
                updateSaveBar();
                loadStatus();
                loadOllamaModels();  // Load available models from Ollama
            } catch (error) {
                showToast('Failed to load configuration', 'error');
                console.error('Error loading config:', error);
            }
        }

        // Load available models from Ollama API
        async function loadOllamaModels() {
            const select = document.getElementById('model');
            const refreshBtn = document.querySelector('.refresh-btn');

            if (refreshBtn) refreshBtn.classList.add('loading');

            try {
                const response = await fetch('/api/ollama/models');
                const data = await response.json();

                // Clear existing options
                select.innerHTML = '';

                if (data.available && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.name;
                        option.textContent = `${model.name} (${model.size})`;
                        select.appendChild(option);
                    });

                    // Set current value from config
                    if (config.summarization && config.summarization.model) {
                        select.value = config.summarization.model;
                        // If current model not in list, add it
                        if (!select.value) {
                            const option = document.createElement('option');
                            option.value = config.summarization.model;
                            option.textContent = `${config.summarization.model} (not installed)`;
                            select.insertBefore(option, select.firstChild);
                            select.value = config.summarization.model;
                        }
                    }
                } else {
                    // Ollama not available - show current model only
                    const option = document.createElement('option');
                    option.value = config.summarization?.model || '';
                    option.textContent = config.summarization?.model
                        ? `${config.summarization.model} (Ollama unavailable)`
                        : 'Ollama unavailable';
                    select.appendChild(option);

                    if (data.error) {
                        console.warn('Ollama models:', data.error);
                    }
                }
            } catch (error) {
                console.error('Error loading Ollama models:', error);
                select.innerHTML = '<option value="">Failed to load models</option>';
                if (config.summarization?.model) {
                    const option = document.createElement('option');
                    option.value = config.summarization.model;
                    option.textContent = config.summarization.model;
                    select.appendChild(option);
                    select.value = config.summarization.model;
                }
            } finally {
                if (refreshBtn) refreshBtn.classList.remove('loading');
            }
        }

        // Update UI with config values
        function updateUI(cfg) {
            // Capture
            setValue('interval_seconds', cfg.capture.interval_seconds);
            setValue('format', cfg.capture.format);
            setValue('quality', cfg.capture.quality);
            setChecked('capture_active_monitor_only', cfg.capture.capture_active_monitor_only);

            // AFK
            setValue('timeout_seconds', cfg.afk.timeout_seconds);
            setValue('min_session_minutes', cfg.afk.min_session_minutes);

            // Summarization
            setChecked('summarization_enabled', cfg.summarization.enabled);
            setValue('model', cfg.summarization.model);
            setValue('trigger_threshold', cfg.summarization.trigger_threshold);
            setChecked('ocr_enabled', cfg.summarization.ocr_enabled);
            setChecked('crop_to_window', cfg.summarization.crop_to_window);
            setChecked('include_previous_summary', cfg.summarization.include_previous_summary);

            // Storage
            setValue('data_dir', cfg.storage.data_dir);
            setValue('max_days_retention', cfg.storage.max_days_retention);
            setValue('max_gb_storage', cfg.storage.max_gb_storage);
            document.getElementById('storage_max').textContent = cfg.storage.max_gb_storage;

            // Privacy
            updateTags('excluded_apps', cfg.privacy.excluded_apps);
        }

        function setValue(id, value) {
            const el = document.getElementById(id);
            if (!el) return;

            if (el.type === 'range') {
                el.value = value;
                updateSliderValue(id, value);
            } else {
                el.value = value;
            }
        }

        function setChecked(id, checked) {
            const el = document.getElementById(id);
            if (el) el.checked = checked;
        }

        function updateSliderValue(id, value) {
            const valueEl = document.getElementById(id + '_value');
            if (valueEl) valueEl.textContent = value;
        }

        function updateTags(containerId, tags) {
            const container = document.getElementById(containerId + '_container');
            if (!container) return;

            const input = container.querySelector('.tag-input');
            container.innerHTML = '';

            tags.forEach(tag => {
                const tagEl = document.createElement('span');
                tagEl.className = 'tag';
                tagEl.innerHTML = `${tag} <span class="tag-remove" onclick="removeTag('${containerId}', '${tag}')">&times;</span>`;
                container.appendChild(tagEl);
            });

            container.appendChild(input);
        }

        function removeTag(containerId, tag) {
            if (containerId === 'excluded_apps') {
                // Get current working copy of excluded apps
                let apps = pendingChanges['excluded_apps']?.value
                    || [...config.privacy.excluded_apps];
                const index = apps.indexOf(tag);
                if (index > -1) {
                    apps.splice(index, 1);
                    trackChange('excluded_apps', 'privacy', 'excluded_apps', apps);
                    updateTags('excluded_apps', apps);
                }
            }
        }

        // Load system status
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                // Ollama status
                const ollamaStatus = document.getElementById('ollama_status');
                if (status.ollama_available) {
                    ollamaStatus.textContent = 'Available';
                    ollamaStatus.className = 'status-badge running';
                } else {
                    ollamaStatus.textContent = 'Unavailable';
                    ollamaStatus.className = 'status-badge stopped';
                }

                // Screenshot count
                document.getElementById('screenshot_count').textContent = status.screenshot_count.toLocaleString();

                // Storage usage
                const used = status.storage_used_gb;
                const max = config.storage.max_gb_storage || 50;
                const percent = max > 0 ? (used / max * 100) : 0;
                document.getElementById('storage_used').textContent = used.toFixed(2);
                document.getElementById('storage_progress').style.width = Math.min(percent, 100) + '%';

                // Monitors
                const monitorList = document.getElementById('monitor_list');
                monitorList.innerHTML = '';
                status.monitors.forEach(monitor => {
                    const li = document.createElement('li');
                    li.className = 'monitor-item' + (monitor.is_primary ? ' primary' : '');
                    li.innerHTML = `
                        <svg class="monitor-icon" viewBox="0 0 24 24">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                        <span>${monitor.name}: ${monitor.width}x${monitor.height}${monitor.is_primary ? ' (primary)' : ''}</span>
                    `;
                    monitorList.appendChild(li);
                });

            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        // Track a pending change (no auto-save)
        function trackChange(elementId, section, key, value) {
            pendingChanges[elementId] = { section, key, value };

            // Check if this change requires restart
            if (restartRequiredKeys.has(key)) {
                requiresRestart = true;
            }

            updateSaveBar();
            markInputChanged(elementId, true);
        }

        // Update save bar and Actions section visibility
        function updateSaveBar() {
            const saveBar = document.getElementById('saveBar');
            const unsavedIndicator = document.getElementById('unsavedIndicator');
            const saveBtn = document.getElementById('saveBtn');
            const discardBtn = document.getElementById('discardBtn');
            const saveRestartBtn = document.getElementById('saveRestartBtn');
            const floatingSaveRestartBtn = document.getElementById('floatingSaveRestartBtn');
            const hasChanges = Object.keys(pendingChanges).length > 0;

            if (hasChanges) {
                // Show unsaved indicator in Actions section
                unsavedIndicator.classList.remove('hidden');
                document.body.classList.add('has-unsaved');

                // Enable save/discard buttons
                saveBtn.disabled = false;
                discardBtn.disabled = false;

                // Show Save & Restart button if any pending change requires restart
                if (requiresRestart) {
                    saveRestartBtn.classList.add('visible');
                    floatingSaveRestartBtn.style.display = 'flex';
                } else {
                    saveRestartBtn.classList.remove('visible');
                    floatingSaveRestartBtn.style.display = 'none';
                }

                // Floating bar visibility based on scroll position
                updateFloatingBarVisibility();
            } else {
                // Hide unsaved indicator
                unsavedIndicator.classList.add('hidden');
                saveBar.classList.add('hidden');
                document.body.classList.remove('has-unsaved');

                // Disable save/discard buttons
                saveBtn.disabled = true;
                discardBtn.disabled = true;

                // Hide Save & Restart buttons
                saveRestartBtn.classList.remove('visible');
                floatingSaveRestartBtn.style.display = 'none';

                requiresRestart = false;
            }
        }

        // Show floating bar only when Actions section is scrolled out of view
        function updateFloatingBarVisibility() {
            const actionsSection = document.getElementById('actionsSection');
            const saveBar = document.getElementById('saveBar');
            const hasChanges = Object.keys(pendingChanges).length > 0;

            if (!hasChanges) {
                saveBar.classList.add('hidden');
                return;
            }

            const rect = actionsSection.getBoundingClientRect();
            const isActionsVisible = rect.top < window.innerHeight && rect.bottom > 0;

            if (isActionsVisible) {
                saveBar.classList.add('hidden');
            } else {
                saveBar.classList.remove('hidden');
            }
        }

        // Mark input as changed
        function markInputChanged(elementId, changed) {
            const el = document.getElementById(elementId);
            if (!el) return;

            if (el.type === 'checkbox') {
                const slider = el.nextElementSibling;
                if (slider) {
                    if (changed) slider.classList.add('changed');
                    else slider.classList.remove('changed');
                }
            } else {
                if (changed) el.classList.add('input-changed');
                else el.classList.remove('input-changed');
            }
        }

        // Save all pending changes
        async function saveChanges() {
            if (Object.keys(pendingChanges).length === 0) {
                showToast('No changes to save', 'warning');
                return;
            }

            try {
                // Save each pending change
                for (const [elementId, change] of Object.entries(pendingChanges)) {
                    const response = await fetch('/api/config', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(change)
                    });

                    const result = await response.json();
                    if (result.success) {
                        config = result.config;
                        markInputChanged(elementId, false);
                    }
                }

                originalConfig = JSON.parse(JSON.stringify(config));
                pendingChanges = {};

                if (requiresRestart) {
                    showToast('Saved! Restart required for some changes to take effect.', 'warning');
                } else {
                    showToast('Settings saved', 'success');
                }

                requiresRestart = false;
                updateSaveBar();

            } catch (error) {
                showToast('Failed to save settings', 'error');
                console.error('Error saving config:', error);
            }
        }

        // Save and restart
        async function saveAndRestart() {
            if (Object.keys(pendingChanges).length === 0) {
                // No changes, just restart
                await restartService();
                return;
            }

            try {
                // Save all changes first
                for (const [elementId, change] of Object.entries(pendingChanges)) {
                    await fetch('/api/config', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(change)
                    });
                }

                showToast('Settings saved. Restarting service...', 'success');
                pendingChanges = {};
                requiresRestart = false;
                updateSaveBar();

                // Now restart
                await restartService();

            } catch (error) {
                showToast('Failed to save and restart', 'error');
                console.error('Error:', error);
            }
        }

        // Restart the service
        async function restartService() {
            try {
                showToast('Restarting service...', 'warning');

                const response = await fetch('/api/restart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    showToast('Service restarting. Page will reload...', 'success');

                    // Wait for service to restart, then reload
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    showToast('Failed to restart: ' + result.error, 'error');
                }

            } catch (error) {
                showToast('Failed to restart service', 'error');
                console.error('Error restarting:', error);
            }
        }

        // Discard pending changes
        function discardChanges() {
            // Reset UI to original values
            updateUI(originalConfig);

            // Clear all changed indicators
            for (const elementId of Object.keys(pendingChanges)) {
                markInputChanged(elementId, false);
            }

            pendingChanges = {};
            requiresRestart = false;
            updateSaveBar();

            showToast('Changes discarded', 'success');
        }

        // Reset configuration
        async function resetConfig() {
            if (!confirm('Reset all settings to defaults?')) return;

            try {
                const response = await fetch('/api/config/reset', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    config = result.config;
                    updateUI(config);
                    showToast('Reset to defaults', 'success');
                }
            } catch (error) {
                showToast('Failed to reset', 'error');
                console.error('Error resetting config:', error);
            }
        }

        // Export configuration
        function exportConfig() {
            const json = JSON.stringify(config, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'activity-tracker-config.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Configuration exported', 'success');
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Event listeners for all inputs
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();

            // Listen for scroll to update floating bar visibility
            window.addEventListener('scroll', updateFloatingBarVisibility);

            // Range inputs
            ['interval_seconds', 'quality', 'timeout_seconds', 'min_session_minutes',
             'trigger_threshold', 'max_days_retention', 'max_gb_storage'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', (e) => {
                        updateSliderValue(id, e.target.value);
                        const { section, key } = getConfigInfo(id);
                        // Use parseFloat for max_gb_storage, parseInt for others
                        const value = id === 'max_gb_storage'
                            ? parseFloat(e.target.value)
                            : parseInt(e.target.value);
                        trackChange(id, section, key, value);
                    });
                }
            });

            // Checkboxes
            ['capture_active_monitor_only', 'summarization_enabled', 'include_previous_summary',
             'ocr_enabled', 'crop_to_window'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', (e) => {
                        const { section, key } = getConfigInfo(id);
                        trackChange(id, section, key, e.target.checked);
                    });
                }
            });

            // Select inputs
            ['format', 'model'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', (e) => {
                        const { section, key } = getConfigInfo(id);
                        trackChange(id, section, key, e.target.value);
                    });
                }
            });

            // Tag input - track changes for excluded apps
            const tagInput = document.getElementById('excluded_apps_input');
            if (tagInput) {
                tagInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && e.target.value.trim()) {
                        const value = e.target.value.trim();
                        // Create a working copy of excluded apps
                        let apps = pendingChanges['excluded_apps']?.value
                            || [...config.privacy.excluded_apps];
                        if (!apps.includes(value)) {
                            apps.push(value);
                            trackChange('excluded_apps', 'privacy', 'excluded_apps', apps);
                            updateTags('excluded_apps', apps);
                        }
                        e.target.value = '';
                        e.preventDefault();
                    }
                });
            }
        });

        // Mapping from element IDs to config {section, key}
        const configMapping = {
            // Capture
            interval_seconds: { section: 'capture', key: 'interval_seconds' },
            format: { section: 'capture', key: 'format' },
            quality: { section: 'capture', key: 'quality' },
            capture_active_monitor_only: { section: 'capture', key: 'capture_active_monitor_only' },
            // AFK
            timeout_seconds: { section: 'afk', key: 'timeout_seconds' },
            min_session_minutes: { section: 'afk', key: 'min_session_minutes' },
            // Summarization
            summarization_enabled: { section: 'summarization', key: 'enabled' },
            model: { section: 'summarization', key: 'model' },
            trigger_threshold: { section: 'summarization', key: 'trigger_threshold' },
            ocr_enabled: { section: 'summarization', key: 'ocr_enabled' },
            crop_to_window: { section: 'summarization', key: 'crop_to_window' },
            include_previous_summary: { section: 'summarization', key: 'include_previous_summary' },
            // Storage
            data_dir: { section: 'storage', key: 'data_dir' },
            max_days_retention: { section: 'storage', key: 'max_days_retention' },
            max_gb_storage: { section: 'storage', key: 'max_gb_storage' },
            // Privacy
            excluded_apps: { section: 'privacy', key: 'excluded_apps' },
            excluded_titles: { section: 'privacy', key: 'excluded_titles' },
            blur_screenshots: { section: 'privacy', key: 'blur_screenshots' },
            // Web
            host: { section: 'web', key: 'host' },
            port: { section: 'web', key: 'port' },
        };

        function getConfigInfo(elementId) {
            return configMapping[elementId] || { section: 'capture', key: elementId };
        }
    </script>
</body>
</html>
