{% extends "base.html" %}

{% block title %}Analytics Dashboard - Activity Tracker{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block extra_styles %}
/* Controls */
.controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    margin-bottom: 30px;
    padding: 15px;
    background: var(--surface);
    border-radius: 8px;
    border: 1px solid var(--border);
    flex-wrap: wrap;
}

.date-range-selector {
    display: flex;
    gap: 10px;
}

.range-btn {
    background: var(--surface-2);
    color: var(--text);
    border: 1px solid var(--border);
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
}

.range-btn:hover {
    border-color: var(--accent);
}

.range-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: var(--text-inverse);
}

.refresh-btn {
    background: var(--success);
    color: #fff;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
}

/* Section Headers */
.section-header {
    font-size: 1.2rem;
    color: var(--accent);
    margin: 30px 0 20px 0;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-header svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    fill: none;
    stroke-width: 2;
}

/* Summary Cards */
.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 30px;
}

.card-title {
    font-size: 0.8rem;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.card-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 4px;
}

.card-value.success { color: var(--success); }
.card-value.warning { color: var(--warning); }
.card-value.danger { color: var(--danger); }

.card-subtitle {
    font-size: 0.85rem;
    color: var(--muted);
}

/* Chart Panels */
.chart-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
}

.chart-panel h3 {
    font-size: 1rem;
    color: var(--accent);
    margin-bottom: 15px;
}

.chart-container {
    position: relative;
    height: 280px;
}

/* Tag Cloud */
.tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px 0;
    min-height: 100px;
}

.tag-item {
    display: inline-flex;
    align-items: center;
    padding: 6px 14px;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 0.85rem;
    color: var(--text);
    cursor: default;
    transition: all 0.2s;
}

.tag-item:hover {
    background: var(--accent);
    color: var(--text-inverse);
    border-color: var(--accent);
}

.tag-item .tag-count {
    background: var(--accent);
    color: var(--text-inverse);
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: 8px;
    font-weight: 600;
}

.tag-item:hover .tag-count {
    background: var(--text-inverse);
    color: var(--accent);
}

.tag-item.size-1 { font-size: 0.75rem; opacity: 0.7; }
.tag-item.size-2 { font-size: 0.85rem; opacity: 0.8; }
.tag-item.size-3 { font-size: 0.95rem; }
.tag-item.size-4 { font-size: 1.05rem; font-weight: 500; }
.tag-item.size-5 { font-size: 1.15rem; font-weight: 600; }

/* Recent Summaries */
.summary-list {
    list-style: none;
}

.summary-item {
    padding: 14px 0;
    border-bottom: 1px solid var(--surface-2);
    display: flex;
    gap: 12px;
    align-items: flex-start;
}

.summary-item:last-child {
    border-bottom: none;
}

.summary-time {
    font-size: 0.8rem;
    color: var(--muted);
    white-space: nowrap;
    min-width: 70px;
}

.summary-content {
    flex: 1;
}

.summary-text {
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 6px;
}

.summary-meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
}

.summary-tag {
    font-size: 0.7rem;
    padding: 2px 8px;
    background: var(--surface-2);
    border-radius: 10px;
    color: var(--muted);
}

.confidence-badge {
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 500;
}

.conf-high { background: rgba(63, 185, 80, 0.2); color: var(--success); }
.conf-medium { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
.conf-low { background: rgba(248, 81, 73, 0.2); color: var(--danger); }

.summary-link {
    color: var(--accent);
    text-decoration: none;
    font-size: 0.8rem;
}

.summary-link:hover {
    text-decoration: underline;
}

/* Focus section */
.metrics-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.metric-card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 16px;
    border-radius: 8px;
    text-align: center;
}

.metric-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: var(--accent);
}

.metric-label {
    color: var(--muted);
    font-size: 0.85rem;
}

.focus-timeline {
    height: 40px;
    background: var(--surface-2);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
}

.timeline-block {
    position: absolute;
    top: 0;
    height: 100%;
    opacity: 0.85;
}

.timeline-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 10px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

/* Tables */
.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th, .data-table td {
    padding: 10px 12px;
    text-align: left;
    border-bottom: 1px solid var(--surface-2);
}

.data-table th {
    color: var(--muted);
    font-weight: 600;
    font-size: 0.8rem;
}

.data-table tbody tr:hover {
    background: var(--surface-2);
}

/* Progress bars */
.progress-bar-container {
    width: 100%;
    height: 6px;
    background: var(--surface-2);
    border-radius: 3px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent-strong));
    border-radius: 3px;
}

/* Loading & empty states */
.skeleton {
    background: linear-gradient(90deg, var(--surface) 25%, var(--surface-2) 50%, var(--surface) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.no-data {
    color: var(--muted);
    font-style: italic;
    text-align: center;
    padding: 30px;
}

@media (max-width: 768px) {
    .chart-row {
        grid-template-columns: 1fr;
    }
    .summary-cards {
        grid-template-columns: repeat(2, 1fr);
    }
}
{% endblock %}

{% block content %}
<div class="controls">
    <div class="date-range-selector">
        <button class="range-btn active" data-range="7">Last 7 days</button>
        <button class="range-btn" data-range="14">Last 14 days</button>
        <button class="range-btn" data-range="30">Last 30 days</button>
    </div>
    <button class="refresh-btn" id="refreshBtn">Refresh</button>
</div>

<!-- AI Insights Section -->
<h2 class="section-header">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    AI Insights
</h2>

<div class="summary-cards" id="aiSummaryCards">
    <div class="card">
        <div class="card-title">Total Summaries</div>
        <div class="card-value" id="totalSummaries">-</div>
        <div class="card-subtitle">Generated in period</div>
    </div>
    <div class="card">
        <div class="card-title">Avg Confidence</div>
        <div class="card-value" id="avgConfidence">-</div>
        <div class="card-subtitle">Model certainty</div>
    </div>
    <div class="card">
        <div class="card-title">High Confidence</div>
        <div class="card-value success" id="highConfCount">-</div>
        <div class="card-subtitle">Reliable summaries</div>
    </div>
    <div class="card">
        <div class="card-title">Unique Tags</div>
        <div class="card-value" id="uniqueTags">-</div>
        <div class="card-subtitle">Activity categories</div>
    </div>
</div>

<!-- Tag Cloud and Confidence Distribution -->
<div class="chart-row">
    <div class="chart-panel">
        <h3>Activity Tags</h3>
        <div class="tag-cloud" id="tagCloud">
            <div class="no-data">Loading tags...</div>
        </div>
    </div>
    <div class="chart-panel">
        <h3 id="confidenceChartLabel">Confidence Distribution</h3>
        <div class="chart-container">
            <canvas id="confidenceChart" role="img" aria-labelledby="confidenceChartLabel" aria-describedby="confidenceChartDesc"></canvas>
            <p id="confidenceChartDesc" class="sr-only">Pie chart showing distribution of AI summary confidence levels</p>
        </div>
    </div>
</div>

<!-- Recent AI Summaries -->
<div class="chart-panel" style="margin-bottom: 30px;">
    <h3>Recent AI Summaries</h3>
    <ul class="summary-list" id="recentSummaries">
        <li class="no-data">Loading summaries...</li>
    </ul>
</div>

<!-- Focus Tracking Section -->
<h2 class="section-header">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    Focus Tracking (Today)
</h2>

<div class="metrics-row" id="focusMetrics">
    <div class="metric-card">
        <div class="metric-value" id="trackedTime">-</div>
        <div class="metric-label">Tracked Time</div>
    </div>
    <div class="metric-card">
        <div class="metric-value" id="contextSwitches">-</div>
        <div class="metric-label">Context Switches</div>
    </div>
    <div class="metric-card">
        <div class="metric-value" id="longestFocus">-</div>
        <div class="metric-label">Longest Focus</div>
    </div>
    <div class="metric-card">
        <div class="metric-value" id="appsUsed">-</div>
        <div class="metric-label">Apps Used</div>
    </div>
</div>

<div class="chart-panel" style="margin-bottom: 20px;">
    <h3 id="focusTimelineLabel">Focus Timeline</h3>
    <div class="focus-timeline" id="focusTimeline" role="img" aria-labelledby="focusTimelineLabel" aria-describedby="focusTimelineDesc"></div>
    <p id="focusTimelineDesc" class="sr-only">Visual timeline showing application usage throughout the day</p>
    <div class="timeline-legend" id="focusLegend"></div>
</div>

<!-- App Usage Section -->
<div class="chart-row">
    <div class="chart-panel">
        <h3 id="appUsageChartLabel">Top Applications</h3>
        <div class="chart-container">
            <canvas id="appUsageChart" role="img" aria-labelledby="appUsageChartLabel" aria-describedby="appUsageChartDesc"></canvas>
            <p id="appUsageChartDesc" class="sr-only">Doughnut chart showing time spent in each application</p>
        </div>
    </div>
    <div class="chart-panel">
        <h3>App Usage Breakdown</h3>
        <div style="max-height: 280px; overflow-y: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Application</th>
                        <th style="text-align: right;">Time</th>
                        <th style="width: 35%;">Usage</th>
                    </tr>
                </thead>
                <tbody id="appTableBody">
                    <tr><td colspan="3" class="no-data">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Activity Trend -->
<div class="chart-panel" style="margin-top: 20px;">
    <h3 id="trendChartLabel">Summary Generation Trend</h3>
    <div class="chart-container">
        <canvas id="trendChart" role="img" aria-labelledby="trendChartLabel" aria-describedby="trendChartDesc"></canvas>
        <p id="trendChartDesc" class="sr-only">Bar chart showing number of AI summaries generated per day</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
    const state = {
        dateRange: 7,
        charts: {},
        data: {}
    };

    document.addEventListener('DOMContentLoaded', () => {
        setupEventListeners();
        loadAllData();
    });

    function setupEventListeners() {
        document.querySelectorAll('.range-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                state.dateRange = parseInt(e.target.dataset.range);
                loadAllData();
            });
        });

        document.getElementById('refreshBtn').addEventListener('click', loadAllData);
    }

    async function loadAllData() {
        try {
            const [aiData, focusData] = await Promise.all([
                fetch(`/api/analytics/ai?days=${state.dateRange}`).then(r => r.json()),
                fetch(`/api/analytics/focus/${getLocalDateString(new Date())}`).then(r => r.json())
            ]);

            state.data.ai = aiData;
            state.data.focus = focusData;

            renderAIInsights(aiData);
            renderFocusSection(focusData);
            renderAppUsageFromFocus(focusData);
            renderTrendChart(aiData);
        } catch (error) {
            console.error('Failed to load data:', error);
        }
    }

    function renderAIInsights(data) {
        document.getElementById('totalSummaries').textContent = data.total_summaries || 0;
        document.getElementById('avgConfidence').textContent = data.avg_confidence ? `${Math.round(data.avg_confidence * 100)}%` : '-';
        document.getElementById('highConfCount').textContent = data.confidence_distribution?.high || 0;
        document.getElementById('uniqueTags').textContent = Object.keys(data.tag_counts || {}).length;

        renderTagCloud(data.tag_counts);
        renderConfidenceChart(data.confidence_distribution);
        renderRecentSummaries(data.recent_summaries);
    }

    function renderTagCloud(tagCounts) {
        const container = document.getElementById('tagCloud');
        const entries = Object.entries(tagCounts || {});

        if (entries.length === 0) {
            container.innerHTML = '<div class="no-data">No tags generated yet.</div>';
            return;
        }

        const maxCount = Math.max(...entries.map(e => e[1]));

        container.innerHTML = entries.map(([tag, count]) => {
            const ratio = count / maxCount;
            let sizeClass = 'size-1';
            if (ratio > 0.8) sizeClass = 'size-5';
            else if (ratio > 0.6) sizeClass = 'size-4';
            else if (ratio > 0.4) sizeClass = 'size-3';
            else if (ratio > 0.2) sizeClass = 'size-2';

            return `<span class="tag-item ${sizeClass}">${escapeHtml(tag)}<span class="tag-count">${count}</span></span>`;
        }).join('');
    }

    function renderConfidenceChart(dist) {
        const ctx = document.getElementById('confidenceChart').getContext('2d');
        const theme = getThemeColors();

        state.charts.confidence = destroyChart(state.charts.confidence);

        const total = (dist?.high || 0) + (dist?.medium || 0) + (dist?.low || 0);
        if (total === 0) {
            ctx.font = '14px sans-serif';
            ctx.fillStyle = theme.muted;
            ctx.textAlign = 'center';
            ctx.fillText('No confidence data yet', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }

        state.charts.confidence = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['High (â‰¥80%)', 'Medium (50-80%)', 'Low (<50%)'],
                datasets: [{
                    data: [dist.high, dist.medium, dist.low],
                    backgroundColor: [theme.success, theme.warning, theme.danger],
                    borderColor: theme.bg,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: theme.text, padding: 15 }
                    }
                }
            }
        });
    }

    function renderRecentSummaries(summaries) {
        const container = document.getElementById('recentSummaries');

        if (!summaries || summaries.length === 0) {
            container.innerHTML = '<li class="no-data">No summaries generated yet.</li>';
            return;
        }

        container.innerHTML = summaries.map(s => {
            const time = s.start_time ? new Date(s.start_time).toLocaleString([], {
                month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            }) : '-';

            let confClass = 'conf-medium';
            let confLabel = 'Medium';
            if (s.confidence >= 0.8) { confClass = 'conf-high'; confLabel = 'High'; }
            else if (s.confidence < 0.5) { confClass = 'conf-low'; confLabel = 'Low'; }

            const tagsHtml = (s.tags || []).slice(0, 3).map(t =>
                `<span class="summary-tag">${escapeHtml(t)}</span>`
            ).join('');

            return `
                <li class="summary-item">
                    <span class="summary-time">${time}</span>
                    <div class="summary-content">
                        <div class="summary-text">${escapeHtml(s.summary)}</div>
                        <div class="summary-meta">
                            ${tagsHtml}
                            ${s.confidence !== null ? `<span class="confidence-badge ${confClass}">${confLabel}</span>` : ''}
                            <a href="/summary/${s.id}" class="summary-link">View details</a>
                        </div>
                    </div>
                </li>
            `;
        }).join('');
    }

    function renderFocusSection(data) {
        if (!data || data.error) {
            document.getElementById('trackedTime').textContent = '0m';
            document.getElementById('contextSwitches').textContent = '0';
            document.getElementById('longestFocus').textContent = '0m';
            document.getElementById('appsUsed').textContent = '0';
            document.getElementById('focusTimeline').innerHTML = '<div class="no-data" style="padding: 10px;">No focus data for today</div>';
            return;
        }

        const metrics = data.metrics || {};
        document.getElementById('trackedTime').textContent = formatDuration(metrics.total_tracked_seconds);
        document.getElementById('contextSwitches').textContent = metrics.context_switches || 0;
        document.getElementById('appsUsed').textContent = metrics.unique_apps || 0;

        const longest = metrics.longest_focus_sessions?.[0];
        document.getElementById('longestFocus').textContent = longest ? formatDuration(longest.duration_seconds) : '0m';

        renderFocusTimeline(data.apps);
    }

    function renderFocusTimeline(apps) {
        const container = document.getElementById('focusTimeline');
        const legend = document.getElementById('focusLegend');

        if (!apps || apps.length === 0) {
            container.innerHTML = '<div class="no-data" style="padding: 10px;">No focus data</div>';
            legend.innerHTML = '';
            return;
        }

        const colors = ['#58a6ff', '#f85149', '#3fb950', '#d29922', '#a371f7', '#ff7b72', '#79c0ff'];
        const total = apps.reduce((sum, a) => sum + (a.total_seconds || 0), 0);

        let html = '';
        let offset = 0;
        apps.forEach((app, i) => {
            const width = ((app.total_seconds || 0) / total) * 100;
            if (width > 0.5) {
                html += `<div class="timeline-block" style="left: ${offset}%; width: ${width}%; background: ${colors[i % colors.length]};" title="${app.app_name}: ${formatDuration(app.total_seconds)}"></div>`;
                offset += width;
            }
        });

        container.innerHTML = html || '<div class="no-data" style="padding: 10px;">No focus data</div>';

        legend.innerHTML = apps.slice(0, 5).map((app, i) => `
            <div class="legend-item">
                <div class="legend-color" style="background: ${colors[i % colors.length]}"></div>
                <span>${app.app_name} (${formatDuration(app.total_seconds)})</span>
            </div>
        `).join('');
    }

    function renderAppUsageFromFocus(data) {
        const apps = data?.apps || [];
        const tbody = document.getElementById('appTableBody');
        const theme = getThemeColors();

        if (apps.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="no-data">No app usage data</td></tr>';
            return;
        }

        const total = apps.reduce((sum, a) => sum + (a.total_seconds || 0), 0);

        tbody.innerHTML = apps.slice(0, 15).map((app, i) => {
            const pct = total > 0 ? ((app.total_seconds / total) * 100).toFixed(1) : 0;
            return `
                <tr>
                    <td><span style="color: var(--muted); margin-right: 8px;">${i + 1}.</span>${escapeHtml(app.app_name)}</td>
                    <td style="text-align: right;">${formatDuration(app.total_seconds)}</td>
                    <td>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${pct}%"></div>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        renderAppPieChart(apps.slice(0, 8));
    }

    function renderAppPieChart(apps) {
        const ctx = document.getElementById('appUsageChart').getContext('2d');
        const theme = getThemeColors();

        state.charts.apps = destroyChart(state.charts.apps);

        if (apps.length === 0) {
            ctx.font = '14px sans-serif';
            ctx.fillStyle = theme.muted;
            ctx.textAlign = 'center';
            ctx.fillText('No app usage data', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }

        const colors = ['#58a6ff', '#f85149', '#3fb950', '#d29922', '#a371f7', '#ff7b72', '#79c0ff', '#ffa657'];

        state.charts.apps = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: apps.map(a => a.app_name),
                datasets: [{
                    data: apps.map(a => a.total_seconds),
                    backgroundColor: colors,
                    borderColor: theme.bg,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { color: theme.text, font: { size: 11 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.label}: ${formatDuration(ctx.raw)}`
                        }
                    }
                }
            }
        });
    }

    function renderTrendChart(data) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        const theme = getThemeColors();

        state.charts.trend = destroyChart(state.charts.trend);

        const byDay = data.summaries_by_day || {};
        const days = [];
        const counts = [];

        for (let i = state.dateRange - 1; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dateStr = getLocalDateString(d);
            days.push(d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            counts.push(byDay[dateStr] || 0);
        }

        state.charts.trend = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: days,
                datasets: [{
                    label: 'Summaries',
                    data: counts,
                    backgroundColor: theme.accent,
                    borderColor: theme.accentStrong,
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: theme.muted, stepSize: 1 },
                        grid: { color: theme.border }
                    },
                    x: {
                        ticks: { color: theme.muted },
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
})();
</script>
{% endblock %}
